import { useState, useMemo, useEffect } from "react";
import { List, ActionPanel, Action, Icon, showToast, Toast } from "@raycast/api";
import { showFailureToast } from "@raycast/utils";

import { QueryProvider, DebugActions } from "@/components";
import { JiraWorklogForm } from "@/pages";
import { copyToClipboardWithToast } from "@/utils";
import { JIRA_WORKLOG_RANGE } from "@/constants";
import { useJiraWorklogsQuery, useJiraCurrentUser } from "@/hooks";
import { getDateRange } from "@/utils";

interface WorklogFilter {
  value: string;
  title: string;
  icon: Icon;
}

const timeRanges: WorklogFilter[] = [
  { value: JIRA_WORKLOG_RANGE.DAILY, title: "Today", icon: Icon.Clock },
  { value: JIRA_WORKLOG_RANGE.WEEKLY, title: "This Week", icon: Icon.Calendar },
  { value: JIRA_WORKLOG_RANGE.MONTHLY, title: "This Month", icon: Icon.Calendar },
];

export default function JiraWorklogViewProvider() {
  return (
    <QueryProvider>
      <JiraWorklogView />
    </QueryProvider>
  );
}

function JiraWorklogView() {
  const [selectedRangeType, setSelectedRangeType] = useState<string>("");

  const { currentUser, error: currentUserError } = useJiraCurrentUser();

  const { from, to } = useMemo(() => getDateRange(selectedRangeType || JIRA_WORKLOG_RANGE.WEEKLY), [selectedRangeType]);

  const {
    data: worklogGroups = [],
    error,
    isLoading,
    isSuccess,
    refetch,
  } = useJiraWorklogsQuery({ userKey: currentUser?.key, from, to });

  useEffect(() => {
    if (currentUserError) {
      showFailureToast(currentUserError, { title: "Failed to Load User" });
    }
  }, [currentUserError]);

  useEffect(() => {
    if (error) {
      showFailureToast(error, { title: "Failed to Load Worklog" });
    }
  }, [error]);

  const handleRefresh = async () => {
    try {
      await refetch();
      showToast(Toast.Style.Success, "Refreshed");
    } catch {
      // Error handling is done by useEffect
    }
  };

  const copyJQL = async () => {
    const issueKeys = [...new Set(worklogGroups.flatMap((group) => group.items.map((item) => item.issueKey)))];

    if (issueKeys.length === 0) {
      await copyToClipboardWithToast("No issues found");
      return;
    }

    const jql = `issuekey in (${issueKeys.join(", ")})`;
    await copyToClipboardWithToast(jql);
  };

  const isEmpty = isSuccess && worklogGroups.length === 0;

  return (
    <List
      throttle
      searchBarPlaceholder="Filter by summary, key, date..."
      isLoading={isLoading}
      searchBarAccessory={
        <List.Dropdown tooltip="Select Time Range" value={selectedRangeType} onChange={setSelectedRangeType} storeValue>
          {timeRanges.map((item) => (
            <List.Dropdown.Item key={item.value} title={item.title} value={item.value} icon={item.icon} />
          ))}
        </List.Dropdown>
      }
    >
      {isEmpty ? (
        <List.EmptyView
          icon={Icon.MagnifyingGlass}
          title="No Results"
          description="No worklogs found for selected time range"
          actions={
            <ActionPanel>
              <Action title="Refresh" icon={Icon.ArrowClockwise} onAction={handleRefresh} />
            </ActionPanel>
          }
        />
      ) : (
        worklogGroups.map((group) => (
          <List.Section key={group.date} title={group.title} subtitle={group.subtitle}>
            {group.items.map((item) => (
              <List.Item
                key={item.renderKey}
                keywords={item.keywords}
                icon={item.icon}
                title={item.title}
                subtitle={item.subtitle}
                accessories={item.accessories}
                actions={
                  <ActionPanel>
                    <Action.OpenInBrowser title="Open in Browser" url={item.url} />
                    <Action.Push
                      title="Create Worklog"
                      target={<JiraWorklogForm issueKey={item.issueKey} onUpdate={handleRefresh} />}
                      icon={Icon.Plus}
                      shortcut={{ modifiers: ["cmd", "shift"], key: "n" }}
                    />
                    <Action.Push
                      title="Edit Worklog"
                      target={
                        <JiraWorklogForm issueKey={item.issueKey} worklogId={item.worklogId} onUpdate={handleRefresh} />
                      }
                      icon={Icon.Pencil}
                      shortcut={{ modifiers: ["cmd", "shift"], key: "e" }}
                    />
                    <Action
                      title="Copy JQL"
                      icon={Icon.CopyClipboard}
                      onAction={() => copyJQL()}
                      shortcut={{ modifiers: ["cmd", "shift"], key: "c" }}
                    />
                    <Action
                      title="Refresh"
                      icon={Icon.ArrowClockwise}
                      shortcut={{ modifiers: ["cmd"], key: "r" }}
                      onAction={handleRefresh}
                    />
                    <DebugActions />
                  </ActionPanel>
                }
              />
            ))}
          </List.Section>
        ))
      )}
    </List>
  );
}
